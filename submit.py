#!/usr/bin/python2
import os
import requests
import time 

SUBMIT_REST_URL = "http://localhost:8090/tasks/create/file"
STATUS_REST_URL = "http://localhost:8090/cuckoo/status"
HEADERS = {"Authorization": "Bearer check your cuckoo.conf"}

SUBMITTED_FILES = "submitted.txt"

# to submit malwares to machines based on their target
MACHINE_SPECIFIC_MAL = {"WinXP" : ["Win32_DLL","Win32_EXE"],
                        "Win7-Home-Prem-32" : ["Win32_DLL","Win32_EXE","MS_","Office_","Outlook"],
"Win7-Home-Prem-64" : ["MS_","Office_","Outlook"]}

All_MACHINES = ["WinXP","Win7-Home-Prem-32","Win7-Home-Prem-64"]

def is_submitted(file_name):
    with open(SUBMITTED_FILES,'r') as submitted:
	if file_name in submitted.read():
	    return True
    return False

def get_target_machines(ransom):
    machines = []
    for machine, mal in MACHINE_SPECIFIC_MAL.items():
        if any(m in ransom for m in mal):
               machines.append(machine)

     # if not for specific machine the run it on all
    if not machines:
         machines = All_MACHINES 
    return machines

def get_pending_tasks():
    r = requests.get(STATUS_REST_URL, headers=HEADERS)
    print(r)
    if(r.status_code == 200):
        return int(r.json()["tasks"]["pending"])


with open('Ransomware_files_10.txt','r') as ran_files_name:
   ransom = ran_files_name.readline()

   while (ransom):

        pending_tasks = get_pending_tasks() 
        if(pending_tasks>5):
             print("Pending tasks: ",pending_tasks)
             time.sleep(60)
             continue
           
	ransom = os.path.splitext(ransom.split()[0])[0]

        # check if it is already submitted
        if(is_submitted(ransom)):
   	    print("already submitted "+ransom)
            ransom = ran_files_name.readline()
            continue
        try:            
		with open(ransom, "rb") as ran_bin:

		    files = {"file": (ransom, ran_bin)}

		    # get target machines
		    machines = get_target_machines(ransom)

		    # send requests for each machine  
		    for mach in machines:
			files['machine'] = mach
			r = requests.post(SUBMIT_REST_URL, headers=HEADERS, files=files)
			if(r.status_code == 200):
                            print("submitte: " + ransom)
			    with open(SUBMITTED_FILES,'a+') as submitted:
			       submitted.write(ransom+" "+ mach +"\n")
        except:
            with open('not_submitted.txt','a+') as not_submitted_file:
		 not_submitted_file.write(ransom+"\n")

        # read next ransom file.         
        ransom = ran_files_name.readline()
